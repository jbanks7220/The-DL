<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesh Control Dashboard</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #0b0c10;
    color: #c5c6c7;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #1f2833;
    padding: 1em 2em;
    text-align: center;
    color: #66fcf1;
    font-size: 1.8em;
    letter-spacing: 1px;
  }
  main {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5em;
    padding: 2em;
    flex: 1;
  }
  section {
    background: #1f2833;
    border-radius: 12px;
    padding: 1em;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
  h2 {
    color: #45a29e;
    font-size: 1.2em;
    margin-top: 0;
    border-bottom: 1px solid #45a29e;
    padding-bottom: 0.5em;
  }
  footer {
    text-align: center;
    padding: 0.5em;
    background: #1f2833;
    color: #45a29e;
    font-size: 0.9em;
  }
  .feed {
    background: #000;
    height: 180px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    border-radius: 8px;
  }
  .status {
    display: flex;
    flex-direction: column;
    gap: 0.5em;
  }
  .status-item {
    background: #0b0c10;
    padding: 0.6em;
    border-radius: 8px;
    font-size: 0.95em;
  }
  .ok { color: #66fcf1; }
  .warn { color: #f5a623; }
  .err { color: #ff4d4d; }
  #map { height: 180px; border-radius: 8px; }
</style>

<!-- Password prompt -->
<script>
const password = prompt("Enter password:");
if (password !== "ThickThighsUwU69!") {
  document.write("<h1 style='text-align:center;color:red;'>Access Denied</h1><p style='text-align:center;'>Wrong password</p>");
  throw new Error("Wrong password");
}
</script>
</head>
<body>

<header>ðŸ›° Mesh Control Dashboard</header>

<main>
  <!-- Mesh Node Status -->
  <section>
    <h2>ðŸ“¡ Network Overview</h2>
    <div id="node-status" class="status">
      <div class="status-item">Loading...</div>
    </div>
  </section>

  <!-- Live Messages -->
  <section>
    <h2>ðŸ’¬ Live Messages</h2>
    <div id="live-messages" class="status">
      <div class="status-item">Waiting for messages...</div>
    </div>
  </section>

  <!-- CCTV Feed -->
  <section>
    <h2>ðŸŽ¥ CCTV / Camera Feed</h2>
    <div class="feed">
      <iframe src="http://172.30.77.134:8081" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </section>

  <!-- System Info -->
  <section>
    <h2>ðŸ’» System Info</h2>
    <div class="status">
      <div class="status-item">CPU Usage: 14%</div>
      <div class="status-item">RAM Usage: 1.8GB / 8GB</div>
      <div class="status-item">Storage Free: 35GB</div>
      <div class="status-item">Network: Bridged (LAN)</div>
    </div>
  </section>

  <!-- Mesh Map -->
  <section>
    <h2>ðŸ—º Mesh Map</h2>
    <div id="map"></div>
  </section>
</main>

<footer>Mesh Dashboard v0.2 â€” Live Mode</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Fetch and update device and message data
async function fetchMeshData() {
  try {
    const response = await fetch('http://192.168.1.179:5000/meshdata.json?_=' + new Date().getTime());
    const data = await response.json();

    // Update Devices
    const nodeContainer = document.getElementById("node-status");
    nodeContainer.innerHTML = "";
    if (data.devices && Object.keys(data.devices).length > 0) {
      for (const [device, lastSeen] of Object.entries(data.devices)) {
        const div = document.createElement("div");
        div.className = "status-item ok";
        div.textContent = `${device}: last seen ${lastSeen}`;
        nodeContainer.appendChild(div);
      }
    } else {
      nodeContainer.innerHTML = '<div class="status-item warn">No active devices</div>';
    }

    // Update Messages
    const msgContainer = document.getElementById("live-messages");
    msgContainer.innerHTML = "";
    if (data.messages && Object.keys(data.messages).length > 0) {
      const sorted = Object.entries(data.messages).sort((a,b) => new Date(b[0]) - new Date(a[0]));
      sorted.slice(0,10).forEach(([timestamp, msg]) => {
        const div = document.createElement("div");
        div.className = "status-item ok";
        div.textContent = `[${timestamp}] ${msg.device}: ${msg.message}`;
        msgContainer.appendChild(div);
      });
    } else {
      msgContainer.innerHTML = '<div class="status-item warn">No recent messages</div>';
    }
  } catch (err) {
    console.error("Error fetching mesh data:", err);
  }
}

// Leaflet map setup
const map = L.map('map').setView([37.7749, -122.4194], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([37.7749, -122.4194]).addTo(map).bindPopup("Gateway Dell");
L.marker([37.7750, -122.4180]).addTo(map).bindPopup("Vortex J24");
L.marker([37.7755, -122.4170]).addTo(map).bindPopup("Samsung A10e");

// Initial and periodic updates
fetchMeshData();
setInterval(fetchMeshData, 10000);
</script>

</body>
</html>
